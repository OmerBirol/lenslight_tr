<%- include("partials/_header") %>
<%- include("partials/_menu", { link: "messages" }) %>

<div class="container" style="margin-top:30px; max-width:800px;">
  <h3><%= otherUser.username %> ile sohbet</h3>

  <div id="chatBox" style="border:1px solid #ddd; padding:10px; min-height:300px; border-radius:8px; overflow-y:auto;">
    <% if (!messages || messages.length === 0) { %>
      <p>HenÃ¼z mesaj yok. Ä°lk mesajÄ± sen at ðŸ™‚</p>
    <% } %>

    <% (messages || []).forEach(m => { %>
      <div style="margin:6px 0; text-align:<%= String(m.sender) === String(me) ? 'right' : 'left' %>;">
        <span style="display:inline-block; padding:8px 12px; border-radius:10px; border:1px solid #ccc; max-width:80%;">
          <%= m.text %>
        </span>
        <div style="font-size:12px; opacity:.6; margin-top:2px;">
          <%= new Date(m.createdAt).toLocaleString() %>
        </div>
      </div>
    <% }) %>
  </div>

  <!-- Not: method/action kalsÄ±n; JS preventDefault ile sayfa yenilenmeyecek.
       JS kapalÄ± olursa fallback olarak POST ile yine Ã§alÄ±ÅŸÄ±r. -->
  <form id="chatForm" method="POST" action="/messages/<%= otherUser._id %>" style="margin-top:10px; display:flex; gap:10px;">
    <input
      id="chatInput"
      type="text"
      name="text"
      placeholder="Mesaj yaz..."
      required
      maxlength="2000"
      style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;"
      autocomplete="off"
    />
    <button type="submit" style="padding:10px 16px; border-radius:8px; border:0;">
      GÃ¶nder
    </button>
  </form>
</div>

<%- include("partials/_footer") %>

<script src="/socket.io/socket.io.js"></script>
<script>
  (function () {
    const socket = io();

    const myId = "<%= me %>";
    const otherId = "<%= otherUser._id %>";

    // server'a kim olduÄŸumu sÃ¶yle
    socket.emit("auth", myId);

    const form = document.getElementById("chatForm");
    const input = document.getElementById("chatInput");
    const box = document.getElementById("chatBox");

    function appendMessage(text, isMine, createdAt) {
      const wrap = document.createElement("div");
      wrap.style.margin = "6px 0";
      wrap.style.textAlign = isMine ? "right" : "left";

      const bubble = document.createElement("span");
      bubble.style.display = "inline-block";
      bubble.style.padding = "8px 12px";
      bubble.style.borderRadius = "10px";
      bubble.style.border = "1px solid #ccc";
      bubble.style.maxWidth = "80%";
      bubble.textContent = text;

      const time = document.createElement("div");
      time.style.fontSize = "12px";
      time.style.opacity = ".6";
      time.style.marginTop = "2px";
      if (createdAt) {
        try { time.textContent = new Date(createdAt).toLocaleString(); } catch (e) {}
      }

      wrap.appendChild(bubble);
      if (createdAt) wrap.appendChild(time);
      box.appendChild(wrap);
      box.scrollTop = box.scrollHeight;
    }

    // Sayfa aÃ§Ä±lÄ±nca en alta kaydÄ±r
    box.scrollTop = box.scrollHeight;

    // gÃ¶nderme: sayfa yenilemeden
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const text = input.value.trim();
      if (!text) return;

      // kendi ekranÄ±ma bas
      appendMessage(text, true, new Date().toISOString());

      // server'a gÃ¶nder (DB kaydÄ± server socket tarafÄ±nda yapÄ±lacak)
      socket.emit("dm:send", {
        toUserId: otherId,
        fromUserId: myId,
        text: text
      });

      input.value = "";
      input.focus();
    });

    // karÅŸÄ±dan gelen mesaj
    socket.on("dm:new", function (payload) {
      // sadece bu konuÅŸmanÄ±n mesajÄ±ysa ekle
      if (String(payload.fromUserId) === String(otherId)) {
        appendMessage(payload.text, false, payload.createdAt);
      }
    });
  })();
</script>
